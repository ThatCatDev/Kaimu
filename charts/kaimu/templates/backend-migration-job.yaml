{{- if .Values.backend.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "kaimu.backend.name" . }}-migrate
  labels:
    {{- include "kaimu.backend.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        {{- include "kaimu.backend.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: migration
    spec:
      {{- include "kaimu.imagePullSecrets" . | nindent 6 }}
      restartPolicy: OnFailure
      initContainers:
        # Wait for PostgreSQL to be ready
        - name: wait-for-postgres
          image: busybox:1.36
          command: ['sh', '-c', 'until nc -z {{ include "kaimu.fullname" . }}-postgresql 5432; do echo "Waiting for PostgreSQL..."; sleep 2; done; echo "PostgreSQL is ready!"']
      containers:
        - name: migrate
          image: "{{ .Values.backend.image.repository }}:{{ .Values.backend.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.backend.image.pullPolicy }}
          command: ["./main", "migrate", "up"]
          env:
            - name: DBHOST
              {{- if and .Values.postgresql.enabled (not .Values.backend.database.host) }}
              value: "{{ include "kaimu.fullname" . }}-postgresql"
              {{- else }}
              value: {{ .Values.backend.database.host | quote }}
              {{- end }}
            - name: DBPORT
              value: {{ .Values.backend.database.port | quote }}
            - name: DBNAME
              {{- if .Values.postgresql.enabled }}
              value: {{ .Values.postgresql.auth.database | quote }}
              {{- else }}
              value: {{ .Values.backend.database.name | quote }}
              {{- end }}
            - name: DBUSERNAME
              {{- if .Values.postgresql.enabled }}
              value: {{ .Values.postgresql.auth.username | quote }}
              {{- else }}
              value: {{ .Values.backend.database.username | quote }}
              {{- end }}
            - name: DBSSL
              value: {{ .Values.backend.database.ssl | quote }}
            - name: DBPASSWORD
              valueFrom:
                secretKeyRef:
                  {{- if .Values.backend.database.existingSecret }}
                  name: {{ .Values.backend.database.existingSecret }}
                  key: {{ .Values.backend.database.existingSecretPasswordKey }}
                  {{- else if .Values.postgresql.enabled }}
                  name: "{{ include "kaimu.fullname" . }}-postgresql"
                  key: password
                  {{- else }}
                  name: {{ include "kaimu.fullname" . }}-backend-secrets
                  key: db-password
                  {{- end }}
{{- end }}
